name: Docker Build Test (DinD)

on:
  workflow_dispatch:

jobs:
  docker-build-test:
    runs-on: arc-runner-set
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker Info
        run: |
          echo "=== Docker Version ==="
          docker version
          echo ""
          echo "=== Docker Info ==="
          docker info
          echo ""
          echo "=== Docker Images (before) ==="
          docker images

      - name: Build Test Image
        run: |
          echo "=== Building test image ==="
          cat > /tmp/Dockerfile << 'EOF'
          FROM alpine:latest
          RUN apk add --no-cache curl
          CMD ["echo", "Hello from self-hosted runner!"]
          EOF
          
          docker build -t test-image:local -f /tmp/Dockerfile /tmp
          
          echo ""
          echo "=== Docker Images (after) ==="
          docker images

      - name: Run Test Container
        run: |
          echo "=== Running container ==="
          docker run --rm test-image:local

      - name: Test Multi-Stage Build (simulating theia-cloud)
        run: |
          echo "=== Multi-stage build test ==="
          cat > /tmp/Dockerfile.multi << 'EOF'
          # Stage 1: Builder
          FROM golang:1.21-alpine AS builder
          RUN apk add --no-cache git
          WORKDIR /app
          RUN echo 'package main; import "fmt"; func main() { fmt.Println("Built on self-hosted runner!") }' > main.go
          RUN go build -o app main.go

          # Stage 2: Runtime
          FROM alpine:latest
          COPY --from=builder /app/app /app
          CMD ["/app"]
          EOF
          
          docker build -t multi-stage-test:local -f /tmp/Dockerfile.multi /tmp
          docker run --rm multi-stage-test:local

      - name: Build Stats
        run: |
          echo "=== Final Docker Stats ==="
          docker images
          echo ""
          echo "=== Disk Usage ==="
          docker system df
          echo ""
          echo "=== SUCCESS: Docker builds work on self-hosted runner! ==="
