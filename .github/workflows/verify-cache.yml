name: Verify Cache Infrastructure

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/verify-cache.yml'
      - 'dockerfiles/**'

jobs:
  verify-apt-cache:
    name: Verify APT Cache
    runs-on: arc-runner-set-stateless-arm
    steps:
      - name: Test apt-cacher-ng connectivity
        run: |
          PROXY="http://apt-cacher-ng.apt-cacher-ng.svc.cluster.local:3142"
          
          echo "Testing apt-cacher-ng connectivity..."
          if ! curl -f -s -o /dev/null -w "%{http_code}" "$PROXY/acng-report.html" | grep -q "200"; then
            echo "âŒ apt-cacher-ng not responding"
            exit 1
          fi
          echo "âœ… apt-cacher-ng is responding"
          
          echo "Testing package list fetch via cache..."
          if ! curl -f -x "$PROXY" "http://ports.ubuntu.com/ubuntu-ports/dists/noble/InRelease" > /dev/null 2>&1; then
            echo "âŒ Failed to fetch via apt-cacher-ng"
            exit 1
          fi
          echo "âœ… Successfully fetched package list via cache"
          
          echo "Verifying cache efficiency (second request should be faster)..."
          TIME1=$(curl -x "$PROXY" -w "%{time_total}" -o /dev/null -s "http://ports.ubuntu.com/ubuntu-ports/dists/noble/InRelease" 2>&1)
          sleep 1
          TIME2=$(curl -x "$PROXY" -w "%{time_total}" -o /dev/null -s "http://ports.ubuntu.com/ubuntu-ports/dists/noble/InRelease" 2>&1)
          
          echo "First request: ${TIME1}s"
          echo "Second request: ${TIME2}s"
          
          if (( $(echo "$TIME2 < $TIME1" | bc -l 2>/dev/null || echo "0") )); then
            echo "âœ… Cache is working (cached request faster: ${TIME2}s < ${TIME1}s)"
          else
            echo "âš ï¸  Cache timing inconclusive (first: ${TIME1}s, second: ${TIME2}s)"
          fi

      - name: Test Docker build with apt-cacher-ng
        run: |
          cat > Dockerfile.test <<'EOF'
          FROM ubuntu:24.04
          ARG APT_HTTP_PROXY
          RUN if [ -n "$APT_HTTP_PROXY" ]; then \
                echo "Acquire::http::Proxy \"$APT_HTTP_PROXY\";" > /etc/apt/apt.conf.d/01proxy; \
                sed -i 's|https://|http://|g' /etc/apt/sources.list.d/*.sources 2>/dev/null || true; \
                sed -i 's|https://|http://|g' /etc/apt/sources.list 2>/dev/null || true; \
                echo "Using APT Proxy with HTTP repositories"; \
              fi
          RUN apt-get update && apt-get install -y curl ca-certificates && rm -rf /var/lib/apt/lists/*
          RUN echo "âœ… APT cache test successful"
          EOF
          
          docker buildx build \
            --build-arg APT_HTTP_PROXY=http://apt-cacher-ng.apt-cacher-ng.svc.cluster.local:3142 \
            --network host \
            -f Dockerfile.test \
            --progress=plain \
            .
          
          echo "âœ… Docker build with apt-cacher-ng succeeded"

      - name: Test eclipse-temurin base image
        run: |
          cat > Dockerfile.temurin-test <<'EOF'
          FROM eclipse-temurin:21-jdk
          ARG APT_HTTP_PROXY
          RUN if [ -n "$APT_HTTP_PROXY" ]; then \
                echo "Acquire::http::Proxy \"$APT_HTTP_PROXY\";" > /etc/apt/apt.conf.d/01proxy; \
                sed -i 's|https://|http://|g' /etc/apt/sources.list.d/*.sources 2>/dev/null || true; \
                sed -i 's|https://|http://|g' /etc/apt/sources.list 2>/dev/null || true; \
                echo "Using APT Proxy with HTTP repositories"; \
              fi
          RUN apt-get update && apt-get install -y maven && rm -rf /var/lib/apt/lists/*
          RUN echo "âœ… Eclipse Temurin with apt-cacher-ng test successful"
          EOF
          
          docker buildx build \
            --build-arg APT_HTTP_PROXY=http://apt-cacher-ng.apt-cacher-ng.svc.cluster.local:3142 \
            --network host \
            -f Dockerfile.temurin-test \
            --progress=plain \
            .
          
          echo "âœ… Eclipse Temurin build with apt-cacher-ng succeeded"

  verify-registry-mirrors:
    name: Verify Registry Mirrors
    runs-on: arc-runner-set-stateless-arm
    steps:
      - name: Test Docker Hub mirror connectivity
        run: |
          MIRROR="http://registry-mirror.registry-mirror.svc.cluster.local:5000"
          
          echo "Testing Docker Hub mirror connectivity..."
          if curl -f -s "$MIRROR/v2/" > /dev/null 2>&1; then
            echo "âœ… Docker Hub mirror is responding"
          else
            echo "âš ï¸  Docker Hub mirror not responding (may be expected if not configured)"
          fi

      - name: Test GHCR mirror connectivity
        run: |
          MIRROR="http://registry-mirror-ghcr.registry-mirror.svc.cluster.local:5000"
          
          echo "Testing GHCR mirror connectivity..."
          if curl -f -s "$MIRROR/v2/" > /dev/null 2>&1; then
            echo "âœ… GHCR mirror is responding"
          else
            echo "âš ï¸  GHCR mirror not responding (may be expected if not configured)"
          fi

      - name: Test image pull
        run: |
          echo "Testing image pull (will use mirrors via buildx config)..."
          if docker pull node:22-alpine > /dev/null 2>&1; then
            echo "âœ… Image pull successful"
          else
            echo "âŒ Image pull failed"
            exit 1
          fi

  verify-npm-cache:
    name: Verify NPM Cache (Verdaccio)
    runs-on: arc-runner-set-stateless-arm
    steps:
      - name: Test Verdaccio registry
        run: |
          REGISTRY="http://verdaccio.verdaccio.svc.cluster.local:4873"
          
          echo "Testing Verdaccio connectivity..."
          if curl -f -s "$REGISTRY" > /dev/null 2>&1; then
            echo "âœ… Verdaccio is responding"
          else
            echo "âŒ Verdaccio not responding"
            exit 1
          fi
          
          echo "Testing package metadata fetch..."
          mkdir -p /tmp/npm-test && cd /tmp/npm-test
          echo "registry=$REGISTRY" > .npmrc
          
          if npm view react version > /dev/null 2>&1; then
            echo "âœ… NPM cache working (package metadata accessible)"
          else
            echo "âš ï¸  NPM cache test inconclusive"
          fi

  report-cache-stats:
    name: Report Cache Statistics
    runs-on: arc-runner-set-stateless-arm
    needs: [verify-apt-cache, verify-registry-mirrors, verify-npm-cache]
    if: always()
    steps:
      - name: Collect cache statistics
        run: |
          echo "## ðŸ“Š Cache Infrastructure Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### APT Cache (apt-cacher-ng)" >> $GITHUB_STEP_SUMMARY
          if command -v kubectl > /dev/null 2>&1 && kubectl get pod -n apt-cacher-ng -l app=apt-cacher-ng > /dev/null 2>&1; then
            POD=$(kubectl get pod -n apt-cacher-ng -l app=apt-cacher-ng -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            if [ -n "$POD" ]; then
              SIZE=$(kubectl exec -n apt-cacher-ng $POD -- du -sh /var/cache/apt-cacher-ng 2>/dev/null | awk '{print $1}' || echo "N/A")
              UPTIME=$(kubectl get pod -n apt-cacher-ng $POD -o jsonpath='{.status.startTime}' 2>/dev/null || echo "N/A")
              echo "- **Cache size:** $SIZE" >> $GITHUB_STEP_SUMMARY
              echo "- **Pod:** \`$POD\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Started:** $UPTIME" >> $GITHUB_STEP_SUMMARY
              echo "- **Status:** ${{ needs.verify-apt-cache.result }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Status:** Pod not found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Status:** kubectl not available or pod not accessible" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Registry Mirrors" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Hub Mirror:** ${{ needs.verify-registry-mirrors.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GHCR Mirror:** ${{ needs.verify-registry-mirrors.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### NPM Cache (Verdaccio)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ needs.verify-npm-cache.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.verify-apt-cache.result }}" = "success" ] && \
             [ "${{ needs.verify-registry-mirrors.result }}" = "success" ] && \
             [ "${{ needs.verify-npm-cache.result }}" = "success" ]; then
            echo "### âœ… All cache infrastructure checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some cache infrastructure checks failed or were skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- APT Cache: ${{ needs.verify-apt-cache.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Registry Mirrors: ${{ needs.verify-registry-mirrors.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- NPM Cache: ${{ needs.verify-npm-cache.result }}" >> $GITHUB_STEP_SUMMARY
          fi
